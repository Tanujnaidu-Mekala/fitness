<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elite AI Voice Coach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/jpeg" href="logo.jpg" />
    <!-- MediaPipe Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        /* ========================================================================
            GLOBAL STYLES & UTILITIES
            ========================================================================
        */
        :root {
            --bg-dark: #000000;
            --bg-darker: #050505;
            --bg-lighter: #1A1A1A;
            --bg-card: rgba(26, 26, 26, 0.6);
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-muted: #666666;
            --border-subtle: rgba(255, 255, 255, 0.1);
            --accent-color: #00FFFF;
            --accent-pink: #F72585;
            --accent-orange: #FF6B35;
            --form-error-color: #FF4747;
            --primary-gradient: linear-gradient(135deg, var(--accent-color) 0%, #0099CC 100%);
            --secondary-gradient: linear-gradient(135deg, var(--accent-orange) 0%, #F7931E 100%);
            --accent-gradient: linear-gradient(135deg, var(--accent-pink) 0%, #C77DFF 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: none;
        }
        
        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }
        
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(247, 37, 133, 0.05) 0%, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Enhanced Custom Cursor */
        .custom-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            z-index: 10001;
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }
        
        .dumbbell-cursor {
            font-size: 40px;
            color: var(--accent-color);
            animation: rotate 3s linear infinite;
            filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.9));
        }
        
        /* Enhanced Smash Effect */
        .smash-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
        }
        
        .smash-particle {
            position: absolute;
            font-size: 16px;
            pointer-events: none;
            animation: smash 0.8s ease-out forwards;
            filter: drop-shadow(0 0 6px rgba(0, 255, 255, 0.7));
        }
        
        /* Breaking glass effect */
        .glass-break {
            position: absolute;
            pointer-events: none;
            animation: glassBreak 0.8s ease-out forwards;
        }
        
        .glass-shard {
            position: absolute;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.8), rgba(0, 255, 255, 0.5));
            pointer-events: none;
            animation: shardFly 1s ease-out forwards;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.7);
        }
        
        /* Screen crack effect */
        .screen-crack {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            background-image: url('https://i.imgur.com/2s7R4Jc.png'); /* A transparent crack image */
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            transition: opacity 0.2s ease-out;
            transform-origin: var(--crack-x) var(--crack-y);
        }
        
        .screen-crack.active {
            opacity: 0.7;
            animation: crack-animation 0.3s ease-out;
        }
        
        /* Floating Particles Background */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            background: var(--accent-color);
            border-radius: 50%;
            opacity: 0.3;
            animation: float-particle 15s infinite linear;
        }
        
        /* Multi-Glow Background Orbs */
        .glow-orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .glow-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float-orb 20s infinite ease-in-out;
        }
        
        .glow-orb-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.8) 0%, rgba(0, 255, 255, 0) 70%);
            top: -200px;
            left: -200px;
            animation-duration: 25s;
        }
        
        .glow-orb-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(247, 37, 133, 0.8) 0%, rgba(247, 37, 133, 0) 70%);
            bottom: -150px;
            right: -150px;
            animation-duration: 30s;
            animation-delay: 2s;
        }
        
        .glow-orb-3 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 107, 53, 0.8) 0%, rgba(255, 107, 53, 0) 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-duration: 35s;
            animation-delay: 5s;
        }
        
        /* ========================================================================
            LOADING SCREEN - From Previous Code
            ========================================================================
        */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-container {
            text-align: center;
            position: relative;
            width: 100%;
            max-width: 500px;
        }
        
        .loading-animation {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-icon {
            font-size: 3rem;
            color: var(--accent-color);
            animation: pulse-grow 1.5s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        
        .loading-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--accent-color);
            transform: rotate(0deg);
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        
        .loading-circle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--accent-color);
        }
        
        .loading-circle-alt {
            position: absolute;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-bottom-color: var(--accent-pink);
            transform: rotate(0deg) scale(0.8);
            animation: spin-reverse 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        
        .loading-text h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .loading-text p {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 2rem;
            font-size: 1.2rem;
            font-family: 'Montserrat', sans-serif;
        }
        
        .loading-progress {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .loading-bar {
            width: 8px;
            height: 30px;
            background: var(--primary-gradient);
            border-radius: 4px;
            animation: loadingPulse 1.4s ease-in-out infinite;
        }
        
        .loading-bar:nth-child(2) {
            animation-delay: 0.2s;
            background: var(--secondary-gradient);
        }
        
        .loading-bar:nth-child(3) {
            animation-delay: 0.4s;
            background: var(--accent-gradient);
        }
        
        .loading-bar:nth-child(4) {
            animation-delay: 0.6s;
            background: var(--primary-gradient);
        }
        
        .loading-bar:nth-child(5) {
            animation-delay: 0.8s;
            background: var(--secondary-gradient);
        }
        
        /* ========================================================================
            HEADER
            ========================================================================
        */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-100%);
            opacity: 0;
            animation: slideDown 0.8s ease 3.5s forwards;
        }
        
        .header.scrolled {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(30px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 80px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            cursor: none;
            transition: all 0.3s ease;
            text-decoration: none;
            letter-spacing: 1px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .logo-icon {
            width: 2.5rem;
            height: 2.5rem;
            color: var(--accent-color);
            animation: pulse 2s infinite;
        }
        
        /* Profile Dropdown Styles */
        .profile-dropdown {
            position: relative;
        }
        
        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            border: none;
            border-radius: 50px;
            color: var(--bg-dark);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }
        
        .profile-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 255, 255, 0.4);
        }
        
        .profile-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            overflow: hidden;
            min-width: 200px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }
        
        .dropdown-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }
        
        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .dropdown-item i {
            width: 16px;
            text-align: center;
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 0.5rem 0;
        }
        
        /* ========================================================================
            MAIN CONTENT SECTIONS
            ========================================================================
        */
        section {
            padding: 80px 0;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            position: relative;
        }
        
        section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(247, 37, 133, 0.05) 0%, transparent 50%);
            z-index: -1;
        }
        
        section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        #chat-coach {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-top: 120px;
        }
        
        #chat-coach .container {
            position: relative;
            z-index: 2;
        }
        
        h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 900;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            position: relative;
            display: block; /* Changed from inline-block to block */
            margin-left: auto;
            margin-right: auto;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%; /* Center the underline */
            transform: translateX(-50%); /* Center the underline */
            width: 0;
            height: 3px;
            background: var(--primary-gradient);
            animation: borderExpand 1s ease forwards;
            animation-delay: 0.5s;
        }
        
        /* ========================================================================
            CHAT COACH UI
            ========================================================================
        */
        .chat-container {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 1.2s ease-out 3.8s forwards;
            transition: all 0.3s ease;
        }
        
        .chat-container:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }
        
        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                rgba(0, 255, 255, 0.1) 0%,
                transparent 70%
            );
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: -1;
        }
        
        .chat-container:hover::before {
            opacity: 1;
        }
        
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 20px;
            -webkit-overflow-scrolling: touch;
            max-height: 50vh;
            margin-bottom: 20px;
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.5;
            font-family: 'Montserrat', sans-serif;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .message:hover {
            transform: translateY(-3px);
        }
        
        .message.ai {
            background-color: var(--bg-card);
            color: var(--text-secondary);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        
        .message.user {
            background-image: var(--primary-gradient);
            color: var(--bg-dark);
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.3);
        }
        
        /* Updated styling for the dropdown container and elements */
        .language-select-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px auto;
            text-align: center;
            flex-wrap: wrap;
        }
        
        #languageSelect {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 10px 15px;
            font-family: 'Montserrat', sans-serif;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23EFEFEF%22%20d%3D%22M287%20117.8c-3.2-3.2-8.3-3.2-11.6%200L146.2%20247.1%2016.9%20117.8c-3.2-3.2-8.3-3.2-11.6%200-3.2%203.2-3.2%208.3%200%2011.6l135.5%20135.5c3.2%203.2%208.3%203.2%2011.6%200l135.5-135.5c3.2-3.2%203.2-8.3%200-11.6z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px;
            padding-right: 30px;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        #languageSelect:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        
        .language-select-container label {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        .input-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s ease-out 4s forwards;
        }
        
        textarea {
            flex-grow: 1;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 25px;
            padding: 12px 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        
        .action-btn,
        .file-upload-label,
        .camera-upload-label,
        .history-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: var(--primary-gradient);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            color: var(--bg-dark);
            font-size: 1.2rem;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.2);
        }
        
        .action-btn:hover,
        .file-upload-label:hover,
        .camera-upload-label:hover,
        .history-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 15px 30px rgba(0, 212, 255, 0.4);
        }
        
        .action-btn.listening {
            animation: pulse 1.5s infinite;
        }
        
        #file-input,
        #camera-input {
            display: none;
        }
        
        .uploaded-content-placeholder {
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: 'Montserrat', sans-serif;
            backdrop-filter: blur(10px);
        }
        /* ========================================================================
            WORKOUT TRACKER SECTION
            ========================================================================
        */
        #workout-tracker .container {
            max-width: 1200px; /* Wider container for side-by-side view */
        }
        .workout-display-area {
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-container, .workout-video-container {
            flex: 1;
            max-width: 640px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            aspect-ratio: 16 / 9;
            position: relative;
        }
        
        #webcam {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1); /* Mirror view */
        }
        #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* Mirror view */
            pointer-events: none; /* Let clicks pass through to video */
        }
        
        #workout-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .workout-video-title {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10;
        }
        
        .workout-setup {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        .workout-setup > div {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
        .workout-setup label {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        .workout-setup select, .workout-setup input, .workout-setup button {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 10px 15px;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            cursor: pointer;
        }
        .workout-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .controls-feedback button {
            margin-bottom: 20px;
        }
        #workout-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .stat-card {
            background: var(--bg-lighter);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-subtle);
        }
        .stat-card h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-transform: uppercase;
        }
        .stat-card p {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        /* ========================================================================
            MOTIVATION & REWARDS SECTION
            ========================================================================
        */
        #motivation-rewards,
        #music-integration {
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            position: relative;
            overflow: hidden;
            padding-bottom: 80px;
        }
        
        #music-integration {
            padding-top: 0;
            padding-bottom: 100px;
        }
        
        .section-title {
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 900;
            margin: 0 auto 50px; /* Center with auto margins */
            text-transform: uppercase;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            position: relative;
            display: block; /* Changed from inline-block to block */
            opacity: 0;
            transform: translateY(30px);
        }
        
        .section-title.visible {
            animation: fadeInUp 1s ease-out forwards;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%; /* Center the underline */
            transform: translateX(-50%); /* Center the underline */
            width: 0;
            height: 3px;
            background: var(--primary-gradient);
            animation: borderExpand 1s ease forwards;
            animation-delay: 0.5s;
        }
        
        #motivation-rewards .container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            padding: 20px 2rem;
        }
        
        #music-integration .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
            padding: 20px 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(40px);
        }
        
        .feature-card.animate-in {
            opacity: 1;
            transform: translateY(0);
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--program-color), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .feature-card:hover::before {
            opacity: 1;
        }
        
        .feature-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                rgba(0, 255, 255, 0.1) 0%,
                transparent 70%
            );
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: -1;
        }
        
        .feature-card:hover::after {
            opacity: 1;
        }
        
        .feature-card:hover {
            transform: translateY(-15px) scale(1.03);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }
        
        .feature-card h4 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-color);
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover h4 {
            transform: translateY(-5px);
        }
        
        .feature-card p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 20px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .feature-placeholder {
            flex-grow: 1;
            width: 100%;
            background-color: var(--bg-lighter);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
            transition: transform 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            border: 1px solid var(--border-subtle);
        }
        
        .feature-card:hover .feature-placeholder {
            transform: scale(1.03);
        }
        
        .feature-btn {
            background-image: var(--primary-gradient);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--bg-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.2);
        }
        .feature-btn.stop-btn {
            background-image: var(--accent-gradient);
            box-shadow: 0 10px 20px rgba(247, 37, 133, 0.2);
        }
        .feature-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 212, 255, 0.4);
        }
         .feature-btn.stop-btn:hover {
            box-shadow: 0 15px 30px rgba(247, 37, 133, 0.4);
        }
        
        .feature-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .feature-btn:hover::after {
            animation: ripple 1s ease-out;
        }
        
        /* ========================================================================
            MUSIC INTEGRATION ENHANCED ANIMATIONS
            ========================================================================
        */
        #music-integration .feature-card h4 i {
            margin-right: 8px;
            animation: musicNote 2s infinite alternate;
        }
        
        @keyframes musicNote {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }
        
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 40px;
            gap: 5px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .equalizer span {
            display: inline-block;
            width: 6px;
            height: 15px;
            background: var(--accent-color);
            border-radius: 3px;
            animation: equalize 1.2s infinite ease-in-out;
        }
        
        .equalizer span:nth-child(1) { animation-delay: 0.2s; }
        .equalizer span:nth-child(2) { animation-delay: 0.3s; }
        .equalizer span:nth-child(3) { animation-delay: 0.4s; }
        .equalizer span:nth-child(4) { animation-delay: 0.1s; }
        .equalizer span:nth-child(5) { animation-delay: 0.5s; }
        
        @keyframes equalize {
            0%, 100% { height: 15px; }
            50% { height: 35px; }
        }
        
        /* ========================================================================
            ENHANCED ANIMATIONS
            ========================================================================
        */
        @keyframes crack-animation {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes borderExpand {
            to { width: 100%; }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-15px); }
        }
        
        @keyframes smash {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0) rotate(720deg);
                opacity: 0;
            }
        }
        
        @keyframes glassBreak {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }
        
        @keyframes shardFly {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--rotation));
                opacity: 0;
            }
        }
        
        @keyframes dumbbell-lift {
            0%, 100% { transform: translateY(20px) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(-15deg); }
            50% { transform: translateY(20px); }
            75% { transform: translateY(-20px) rotate(15deg); }
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        @keyframes pulse-grow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes loadingPulse {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes spin-reverse {
            from { transform: rotate(0deg) scale(0.8); }
            to { transform: rotate(-360deg) scale(0.8); }
        }
        
        @keyframes float-particle {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 0.4;
            }
            90% {
                opacity: 0.4;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }
        
        @keyframes float-orb {
            0%, 100% {
                transform: translate(0, 0);
            }
            25% {
                transform: translate(20px, -30px);
            }
            50% {
                transform: translate(-15px, 20px);
            }
            75% {
                transform: translate(30px, 10px);
            }
        }
        
        /* ========================================================================
            RESPONSIVE DESIGN
            ========================================================================
        */
        @media (max-width: 1200px) {
            #motivation-rewards .container {
                grid-template-columns: repeat(2, 1fr);
            }
            .workout-display-area {
                flex-direction: column;
                align-items: center;
            }
            .video-container, .workout-video-container {
                max-width: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }
            
            .chat-container {
                padding: 20px;
            }
            
            .input-area {
                flex-wrap: wrap;
            }
            
            .action-btn,
            .file-upload-label,
            .camera-upload-label,
            .history-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            textarea {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            h2 {
                font-size: clamp(2rem, 5vw, 3rem);
            }
            
            .section-title {
                font-size: clamp(2rem, 5vw, 3rem);
            }
            
            #motivation-rewards .container {
                grid-template-columns: 1fr;
            }
             #workout-stats {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 1rem;
            }
            
            section {
                padding: 60px 0;
            }
            
            .chat-history {
                max-height: 40vh;
            }
            
            .feature-card {
                padding: 20px;
            }
            
            .feature-card h4 {
                font-size: 1.2rem;
            }
             #workout-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        /* Add these rules to your CSS */
        section {
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        section:not(.visible) {
            opacity: 0 !important;
            transform: translateY(50px) !important;
            pointer-events: none; /* Prevent interaction with hidden sections */
        }
        
        .section-title {
            transition: opacity 0.6s ease 0.2s, transform 0.6s ease 0.2s;
        }
        
        .section-title:not(.visible) {
            opacity: 0 !important;
            transform: translateY(30px) !important;
        }
        
        .feature-card {
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        .feature-card:not(.animate-in) {
            opacity: 0 !important;
            transform: translateY(40px) !important;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-animation">
                <div class="loading-circle"></div>
                <div class="loading-circle-alt"></div>
                <i class="fas fa-dumbbell loading-icon"></i>
            </div>
            <div class="loading-text">
                <h2>ELITE AI COACH</h2>
                <p>"Your personal trainer, powered by AI"</p>
            </div>
            <div class="loading-progress">
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
            </div>
        </div>
    </div>
    
    <div class="custom-cursor">
        <i class="fas fa-dumbbell dumbbell-cursor"></i>
    </div>
    
    <div class="smash-container"></div>
    
    <div class="screen-crack"></div>
    
    <div class="particles-container"></div>
    
    <!-- Multi-Glow Background Orbs -->
    <div class="glow-orbs">
        <div class="glow-orb glow-orb-1"></div>
        <div class="glow-orb glow-orb-2"></div>
        <div class="glow-orb glow-orb-3"></div>
    </div>
    
    <header>
        <div class="header-content">
            <a href="plan.html" class="logo">
                <i class="fas fa-dumbbell logo-icon"></i>
                <span>ELITE AI</span>
            </a>
            
            <!-- Profile Dropdown -->
            <div class="profile-dropdown">
                <button class="profile-btn" id="profileBtn">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="userName">Athlete</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="profileDropdown">
                    
                    <div class="dropdown-divider"></div>
                    <a href="index.html" class="dropdown-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <section id="chat-coach">
            <div class="container">
                <h2 class="text-gradient">AI Voice & Chat Coach</h2>
                <div class="chat-container">
                    <div class="chat-history" id="chatHistory">
                        <div class="message ai">Hello! I'm your AI Voice Coach. How can I help you with your workout goals today?</div>
                    </div>
                    <div class="language-select-container">
                        <label for="languageSelect">Select a Voice:</label>
                        <select id="languageSelect">
                        </select>
                    </div>
                    <div class="input-area">
                        <button id="startVoice" class="action-btn" title="Start voice input"><i class="fas fa-microphone"></i></button>
                        <button id="stopVoice" class="action-btn" title="Stop voice output" style="display:none;"><i class="fas fa-stop"></i></button>
                         <label for="camera-input" class="camera-upload-label" title="Upload from camera"><i class="fas fa-camera"></i></label>
                        <input type="file" id="camera-input" accept="image/*" capture="environment">
                        <button id="historyButton" class="history-btn" title="View/Clear History"><i class="fas fa-history"></i></button>
                        <textarea id="userInput" placeholder="Speak or type your request..." rows="1"></textarea>
                        <button id="sendButton" class="action-btn" title="Send message"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </section>
        <!-- New Workout Tracker Section -->
        <section id="workout-tracker">
            <h3 class="section-title text-gradient">Live Workout Tracker</h3>
            <div class="container">
                <div class="tracker-container">
                     <div class="workout-setup">
                         <div>
                             <label for="exercise-select">Choose Exercise</label>
                             <select id="exercise-select">
                                 <optgroup label="Strength">
                                     <option value="squats">Squats</option>
                                     <option value="lunges">Lunges</option>
                                     <option value="push_ups">Push-ups</option>
                                     <option value="bicep_curls">Bicep Curls</option>
                                     <option value="shoulder_press">Shoulder Press</option>
                                     <option value="sit_ups">Sit-ups</option>
                                     <option value="crunches">Crunches</option>
                                     <option value="russian_twists">Russian Twists</option>
                                     <option value="leg_raises">Leg Raises</option>
                                     <option value="tricep_dips">Tricep Dips</option>
                                     <option value="glute_bridges">Glute Bridges</option>
                                     <option value="plank">Plank</option>
                                     <option value="side_plank">Side Plank</option>
                                     <option value="lateral_raises">Lateral Raises</option>
                                     <option value="overhead_tricep_extensions">Overhead Tricep Extensions</option>
                                 </optgroup>
                                 <optgroup label="Cardio">
                                     <option value="high_knees">High Knees</option>
                                     <option value="jumping_jacks">Jumping Jacks</option>
                                     <option value="burpees">Burpees</option>
                                     <option value="mountain_climbers">Mountain Climbers</option>
                                     <option value="skater_jumps">Skater Jumps</option>
                                     <option value="butt_kicks">Butt Kicks</option>
                                     <option value="jump_squats">Jump Squats</option>
                                 </optgroup>
                                 <optgroup label="Flexibility & Balance">
                                     <option value="tree_pose">Tree Pose</option>
                                     <option value="warrior_pose">Warrior II Pose</option>
                                     <option value="downward_dog">Downward Dog</option>
                                 </optgroup>
                             </select>
                         </div>
                         <div>
                             <label for="rep-target">Set Target</label>
                             <input type="number" id="rep-target" value="10" min="1">
                         </div>
                     </div>
                     <div class="workout-display-area" id="workout-display-area">
                        <div class="video-container" id="video-container">
                            <video id="webcam" class="input_video" autoplay playsinline></video>
                            <canvas id="output_canvas" width="1280px" height="720px"></canvas>
                        </div>
                        <div class="workout-video-container" id="workout-video-container">
                            <video id="workout-video" autoplay muted loop></video>
                            <div class="workout-video-title" id="workout-video-title">Squats</div>
                        </div>
                    </div>
                    <div class="controls-feedback">
                        <div class="workout-controls">
                            <button id="startWorkoutBtn" class="feature-btn">Start Workout</button>
                            <button id="stopWorkoutBtn" class="feature-btn stop-btn hidden">Stop Workout</button>
                        </div>
                        <div id="workout-stats" class="hidden">
                            <div class="stat-card">
                                <h4 id="target-title">Target Reps</h4>
                                <p id="target-reps-display">10</p>
                            </div>
                             <div class="stat-card">
                                <h4 id="count-title">Reps</h4>
                                <p id="rep-count">0</p>
                            </div>
                            <div class="stat-card">
                                <h4>Stage</h4>
                                <p id="stage-display">-</p>
                            </div>
                            <div class="stat-card">
                                <h4>Feedback</h4>
                                <p id="feedback-text">Ready to start!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="motivation-rewards">
            <h3 class="section-title text-gradient">Motivation & Rewards</h3>
            <div class="container">
                <div class="feature-card" style="--program-color: var(--accent-color);">
                    <h4>Today's Challenge</h4>
                    <p>Daily AI goal setting</p>
                    <div class="feature-placeholder">Today's challenge: 300 punches in 15 min.</div>
                </div>
                <div class="feature-card" style="--program-color: var(--accent-orange);">
                    <h4>Rewards Store</h4>
                    <p>Points & rewards store</p>
                    <div class="feature-placeholder">Unlock badges, wallpapers, and music playlists with your points.</div>
                </div>
                <div class="feature-card" style="--program-color: var(--accent-pink);">
                    <h4>Workout Calendar</h4>
                    <p>AI workout calendar</p>
                    <div class="feature-placeholder">Color-coded progress tracking for your workouts.</div>
                </div>
            </div>
        </section>
        
        <section id="music-integration">
            <h3 class="section-title text-gradient">Music Integration</h3>
            <div class="container">
                <div class="feature-card" style="--program-color: var(--accent-color);">
                    <h4><i class="fas fa-music"></i>Create Workout Playlists</h4>
                    <p>Connect your favorite music streaming service to generate personalized workout playlists.</p>
                    <div class="feature-placeholder">
                        <button id="connectSpotifyBtn" class="feature-btn">Connect to Spotify</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Element References ---
            const chatHistory = document.getElementById('chatHistory');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const startVoiceButton = document.getElementById('startVoice');
            const stopVoiceButton = document.getElementById('stopVoice');
            const languageSelect = document.getElementById('languageSelect');
            const fileInput = document.getElementById('file-input');
            const cameraInput = document.getElementById('camera-input');
            const connectSpotifyBtn = document.getElementById('connectSpotifyBtn');
            const historyButton = document.getElementById('historyButton');
            const loadingScreen = document.getElementById('loadingScreen');
            
            // Profile dropdown elements
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            const userNameElement = document.getElementById('userName');
            
            // --- Workout Tracker Elements ---
            const startWorkoutBtn = document.getElementById('startWorkoutBtn');
            const stopWorkoutBtn = document.getElementById('stopWorkoutBtn');
            const workoutDisplayArea = document.getElementById('workout-display-area');
            const videoContainer = document.getElementById('video-container');
            const videoElement = document.getElementById('webcam');
            const canvasElement = document.getElementById('output_canvas');
            const canvasCtx = canvasElement.getContext('2d');
            const workoutStats = document.getElementById('workout-stats');
            const repCountElement = document.getElementById('rep-count');
            const feedbackTextElement = document.getElementById('feedback-text');
            const exerciseSelect = document.getElementById('exercise-select');
            const repTargetInput = document.getElementById('rep-target');
            const targetRepsDisplay = document.getElementById('target-reps-display');
            const stageDisplay = document.getElementById('stage-display');
            const targetTitle = document.getElementById('target-title');
            const countTitle = document.getElementById('count-title');
            
            // Workout video elements
            const workoutVideoContainer = document.getElementById('workout-video-container');
            const workoutVideo = document.getElementById('workout-video');
            const workoutVideoTitle = document.getElementById('workout-video-title');
            
            // --- Exercise Video Mapping ---
            const exerciseVideos = {
                'squats': 'squat.mp4',
                'lunges': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                'push_ups': 'pushup.mp4.mp4',
                'bicep_curls': 'https://iconscout.com/lottie-animation/man-doing-barbell-bicep-curl-exercise-for-arm-11095291_8971931',
                'shoulder_press': 'https://iconscout.com/lottie-animation/boy-using-dumbbell-15384455_12495730',
                'sit_ups': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                'crunches': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4',
                'russian_twists': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',
                'leg_raises': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4',
                'tricep_dips': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',
                'glute_bridges': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/VolkswagenGTIReview.mp4',
                'plank': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4',
                'side_plank': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WhatCarCanYouGetForAGrand.mp4',
                'lateral_raises': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                'overhead_tricep_extensions': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                'high_knees': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                'jumping_jacks': 'jump.mp4.mp4',
                'burpees': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4',
                'mountain_climbers': 'climber.mp4.mp4',
                'skater_jumps': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4',
                'butt_kicks': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',
                'jump_squats': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4',
                'tree_pose': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',
                'warrior_pose': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/VolkswagenGTIReview.mp4',
                'downward_dog': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4'
            };
            
            // Hide loading screen after animation
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 3500);
            
            // Profile dropdown functionality
            const storedName = localStorage.getItem('userName');
            if (storedName) {
                userNameElement.textContent = storedName;
            }
            
            profileBtn.addEventListener('click', () => {
                profileDropdown.classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.profile-dropdown')) {
                    profileDropdown.classList.remove('active');
                }
            });
            
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('userName');
                window.location.href = 'index.html';
            });
            
            // Floating particles background
            const createParticle = () => {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 6 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                const colors = ['rgba(0, 255, 255, 0.5)', 'rgba(247, 37, 133, 0.5)', 'rgba(255, 107, 53, 0.5)'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                const duration = Math.random() * 10 + 10;
                particle.style.animationDuration = `${duration}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                document.querySelector('.particles-container').appendChild(particle);
                setTimeout(() => { particle.remove(); }, duration * 1000);
            };
            for (let i = 0; i < 30; i++) { setTimeout(createParticle, i * 100); }
            const particleInterval = setInterval(createParticle, 300);
            window.addEventListener('beforeunload', () => { clearInterval(particleInterval); });
            
            connectSpotifyBtn.addEventListener('click', () => { window.open('https://www.spotify.com', '_blank'); });
            
            const synth = window.speechSynthesis;
            let voices = [];
            
            function populateLanguageSelect() {
                voices = synth.getVoices();
                languageSelect.innerHTML = '';
                const languages = [
                    { name: 'US English', lang: 'en-US' }, { name: 'British English', lang: 'en-GB' },
                    { name: 'Australian English', lang: 'en-AU' }, { name: 'Indian English', lang: 'en-IN' },
                    { name: 'Canadian English', lang: 'en-CA' }, { name: 'Hindi', lang: 'hi-IN' }, { name: 'Telugu', lang: 'te-IN' }
                ];
                languages.forEach((langOption) => {
                    const foundVoice = voices.find(voice => voice.lang.startsWith(langOption.lang));
                    if (foundVoice) {
                        const option = document.createElement('option');
                        option.textContent = langOption.name;
                        option.value = foundVoice.name;
                        languageSelect.appendChild(option);
                    }
                });
                const defaultVoice = voices.find(voice => voice.default);
                if (defaultVoice && languages.some(l => defaultVoice.lang.startsWith(l.lang))) {
                    const defaultVoiceOption = languageSelect.querySelector(`option[value="${defaultVoice.name}"]`);
                    if (defaultVoiceOption) { languageSelect.value = defaultVoice.name; }
                } else if (languageSelect.options.length > 0) {
                    languageSelect.value = languageSelect.options[0].value;
                }
            }
            
            if ('onvoiceschanged' in synth) { synth.onvoiceschanged = populateLanguageSelect; } else { populateLanguageSelect(); }
            
            function speak(text) {
                if (synth.speaking) { synth.cancel(); }
                const cleanText = String(text).replace(/\*/g, '');
                const utterance = new SpeechSynthesisUtterance(cleanText);
                const selectedVoiceName = languageSelect.value;
                const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
                if (selectedVoice) { utterance.voice = selectedVoice; }
                
                // Don't toggle main UI buttons for workout feedback
                const isWorkoutFeedback = !isNaN(parseInt(text)) || lastFeedback === text;
                if(!isWorkoutFeedback) {
                    startVoiceButton.style.display = 'none';
                    stopVoiceButton.style.display = 'flex';
                    utterance.onend = () => {
                        stopVoiceButton.style.display = 'none';
                        startVoiceButton.style.display = 'flex';
                    };
                }
                synth.speak(utterance);
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                languageSelect.addEventListener('change', () => {
                    const selectedVoice = voices.find(voice => voice.name === languageSelect.value);
                    if (selectedVoice) { recognition.lang = selectedVoice.lang; }
                });
                recognition.lang = languageSelect.options[0]?.value ? voices.find(v => v.name === languageSelect.options[0].value).lang : 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                startVoiceButton.addEventListener('click', () => {
                    startVoiceButton.classList.add('listening');
                    try { synth.cancel(); recognition.start(); } catch (error) {
                        console.error('Speech recognition failed to start:', error);
                        startVoiceButton.classList.remove('listening');
                        addMessage("Voice recognition failed to start. Please check your microphone permissions.", 'ai');
                        speak("Voice recognition failed to start. Please check your microphone permissions.");
                    }
                });
                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    userInput.value = speechResult;
                    handleUserInput(speechResult);
                };
                recognition.onend = () => { startVoiceButton.classList.remove('listening'); };
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    startVoiceButton.classList.remove('listening');
                    addMessage(`Voice recognition error: ${event.error}. Please try again.`, 'ai');
                    speak("Sorry, I didn't catch that. Please try again.");
                };
            } else {
                startVoiceButton.style.display = 'none';
                console.warn('Web Speech Recognition API not supported in this browser.');
                addMessage("Voice recognition is not supported in this browser. Please use the text input.", 'ai');
            }
            
            stopVoiceButton.addEventListener('click', () => {
                if (synth.speaking) {
                    synth.cancel();
                    stopVoiceButton.style.display = 'none';
                    startVoiceButton.style.display = 'flex';
                }
            });
            
            function addMessage(text, sender, content = null) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', sender);
                if (text) { messageElement.textContent = text; }
                if (content) {
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('uploaded-content-placeholder');
                    contentDiv.innerHTML = `<i class="fas fa-file"></i><span>${content}</span>`;
                    messageElement.appendChild(contentDiv);
                }
                chatHistory.appendChild(messageElement);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            async function handleUserInput(userText = userInput.value.trim()) {
                if (userText) {
                    addMessage(userText, 'user');
                    userInput.value = '';
                    try {
                        const response = await fetch('http://127.0.0.1:5000/api/askAI', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: userText })
                        });
                        const data = await response.json();
                        if (data.success) {
                            const aiText = data.answer; addMessage(aiText, 'ai'); speak(aiText);
                        } else { addMessage(data.message, 'ai'); speak(data.message); }
                    } catch (error) {
                        console.error('API Error:', error);
                        addMessage("I'm sorry, I'm having trouble connecting to the AI. Please try again later.", 'ai');
                        speak("I'm sorry, I'm having trouble connecting to the AI. Please try again later.");
                    }
                }
            }
            
            sendButton.addEventListener('click', () => handleUserInput());
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserInput(); }
            });
            
            // --- Workout Tracker Logic ---
            let repCounter = 0;
            let stage = null;
            let isWorkoutActive = false;
            let lastFeedback = "";
            let feedbackCooldown = false;
            let lastCorrectForm = true;
            let timerInterval = null;
            let secondsElapsed = 0;
            let formErrors = {};
            const exerciseTypes = {
                'squats': 'reps', 'lunges': 'reps', 'push_ups': 'reps', 'bicep_curls': 'reps', 'shoulder_press': 'reps',
                'sit_ups': 'reps', 'crunches': 'reps', 'russian_twists': 'reps', 'leg_raises': 'reps', 'tricep_dips': 'reps',
                'glute_bridges': 'reps', 'lateral_raises': 'reps', 'overhead_tricep_extensions': 'reps', 'high_knees': 'reps',
                'jumping_jacks': 'reps', 'burpees': 'reps', 'mountain_climbers': 'reps', 'skater_jumps': 'reps',
                'butt_kicks': 'reps', 'jump_squats': 'reps',
                'plank': 'time', 'side_plank': 'time', 'tree_pose': 'time', 'warrior_pose': 'time', 'downward_dog': 'time'
            };
            
            function setupExerciseUI() {
                const selectedExercise = exerciseSelect.value;
                const type = exerciseTypes[selectedExercise];
                const targetLabel = document.querySelector('label[for="rep-target"]');
                if (type === 'time') {
                    targetLabel.textContent = "Set Time Target (s)";
                    countTitle.textContent = "Time";
                    targetTitle.textContent = "Target Time";
                    repCountElement.textContent = "0s";
                    targetRepsDisplay.textContent = repTargetInput.value + "s";
                } else { // reps
                    targetLabel.textContent = "Set Rep Target";
                    countTitle.textContent = "Reps";
                    targetTitle.textContent = "Target Reps";
                    repCountElement.textContent = "0";
                    targetRepsDisplay.textContent = repTargetInput.value;
                }
                
                // Update workout video
                if (exerciseVideos[selectedExercise]) {
                    workoutVideo.src = exerciseVideos[selectedExercise];
                    workoutVideoTitle.textContent = exerciseSelect.options[exerciseSelect.selectedIndex].text;
                }
            }
            
            function calculateAngle(a, b, c) {
                if(!a || !b || !c || a.visibility < 0.5 || b.visibility < 0.5 || c.visibility < 0.5) return null;
                const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
                let angle = Math.abs(radians * 180.0 / Math.PI);
                if (angle > 180.0) { angle = 360 - angle; }
                return angle;
            }
            
            function provideFeedback(text, isGoodForm = false) {
                 if (isGoodForm) {
                       if (lastFeedback !== "Good Form") {
                           feedbackTextElement.textContent = "Good Form!";
                           lastFeedback = "Good Form";
                       }
                       return;
                 }
                if (text !== lastFeedback && !feedbackCooldown) {
                    feedbackTextElement.textContent = text;
                    speak(text);
                    lastFeedback = text;
                    feedbackCooldown = true;
                    setTimeout(() => { feedbackCooldown = false; }, 3000); // 3 second cooldown
                }
            }
            
            function onResults(results) {
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
                
                if (results.poseLandmarks) {
                    formErrors = {}; // Reset errors each frame
                    if(isWorkoutActive) {
                        const currentExercise = exerciseSelect.value;
                        const landmarks = results.poseLandmarks;
                        switch(currentExercise) {
                            case 'bicep_curls': processBicepCurls(landmarks); break;
                            case 'squats': processSquats(landmarks); break;
                            case 'push_ups': processPushups(landmarks); break;
                            case 'shoulder_press': processShoulderPress(landmarks); break;
                            case 'lunges': processLunges(landmarks); break;
                            case 'lateral_raises': processLateralRaises(landmarks); break;
                            case 'overhead_tricep_extensions': processOverheadTricepExtensions(landmarks); break;
                            case 'jumping_jacks': processJumpingJacks(landmarks); break;
                            case 'high_knees': processHighKnees(landmarks); break;
                            case 'glute_bridges': processGluteBridges(landmarks); break;
                            case 'crunches': processCrunches(landmarks); break;
                            case 'sit_ups': processSitups(landmarks); break;
                            case 'russian_twists': processRussianTwists(landmarks); break;
                            case 'leg_raises': processLegRaises(landmarks); break;
                            case 'tricep_dips': processTricepDips(landmarks); break;
                            case 'burpees': processBurpees(landmarks); break;
                            case 'mountain_climbers': processMountainClimbers(landmarks); break;
                            case 'skater_jumps': processSkaterJumps(landmarks); break;
                            case 'butt_kicks': processButtKicks(landmarks); break;
                            case 'jump_squats': processJumpSquats(landmarks); break;
                            case 'plank': processPlank(landmarks, false); break;
                            case 'side_plank': processPlank(landmarks, true); break;
                            case 'tree_pose': processTreePose(landmarks); break;
                            case 'warrior_pose': processWarriorPose(landmarks); break;
                            case 'downward_dog': processDownwardDog(landmarks); break;
                        }
                    }
                    // Drawing logic
                    const defaultMaterial = { color: '#00FFFF', lineWidth: 4 };
                    const errorMaterial = { color: 'red', lineWidth: 6 };
                    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, defaultMaterial);
                    
                    const partMap = {
                        'left_elbow': POSE_CONNECTIONS.filter(c => c.includes(11) || c.includes(13) || c.includes(15)),
                        'right_elbow': POSE_CONNECTIONS.filter(c => c.includes(12) || c.includes(14) || c.includes(16)),
                        'left_shoulder': POSE_CONNECTIONS.filter(c => c.includes(11) || c.includes(13) || c.includes(23)),
                        'right_shoulder': POSE_CONNECTIONS.filter(c => c.includes(12) || c.includes(14) || c.includes(24)),
                        'left_hip': POSE_CONNECTIONS.filter(c => c.includes(11) || c.includes(23) || c.includes(25)),
                        'right_hip': POSE_CONNECTIONS.filter(c => c.includes(12) || c.includes(24) || c.includes(26)),
                        'left_knee': POSE_CONNECTIONS.filter(c => c.includes(23) || c.includes(25) || c.includes(27)),
                        'right_knee': POSE_CONNECTIONS.filter(c => c.includes(24) || c.includes(26) || c.includes(28)),
                    };
                    Object.keys(formErrors).forEach(part => {
                        if (formErrors[part] && partMap[part]) {
                            drawConnectors(canvasCtx, results.poseLandmarks, partMap[part], errorMaterial);
                        }
                    });
                    drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#F72585', lineWidth: 2 });
                }
                canvasCtx.restore();
            }
            
            function getVisibleSide(landmarks, parts) {
                const l_vis = parts.reduce((sum, part) => sum + (landmarks[part.l]?.visibility || 0), 0);
                const r_vis = parts.reduce((sum, part) => sum + (landmarks[part.r]?.visibility || 0), 0);
                
                const threshold = parts.length * 0.6; // visibility threshold
                if (l_vis > r_vis && l_vis > threshold) {
                    return 'left';
                } else if (r_vis > threshold) {
                    return 'right';
                }
                return null;
            }
            
            // --- Individual Exercise Logic ---
            function processBicepCurls(landmarks) {
                const side = getVisibleSide(landmarks, [{l: 11, r: 12}, {l: 13, r: 14}, {l: 15, r: 16}]);
                if (!side) {
                    provideFeedback("Stand sideways for accurate curl tracking.");
                    return;
                }
                const shoulder = landmarks[side === 'left' ? 11 : 12];
                const elbow = landmarks[side === 'left' ? 13 : 14];
                const wrist = landmarks[side === 'left' ? 15 : 16];
                
                const angle = calculateAngle(shoulder, elbow, wrist);
                if (angle === null) return;
                
                let formOK = true;
                if (Math.abs(elbow.x - shoulder.x) > 0.12) {
                    provideFeedback("Keep your elbow tucked in!");
                    formErrors[side + '_elbow'] = true;
                    formOK = false;
                } else {
                    provideFeedback("Good form!", true);
                }
                
                if (angle > 160) {
                    stage = "down";
                }
                if (angle < 35 && stage === 'down') {
                    stage = "up";
                    if (formOK) {
                        repCounter++;
                        speak(String(repCounter));
                        repCountElement.textContent = repCounter;
                    } else {
                        provideFeedback("Rep not counted. Keep elbows in.");
                    }
                }
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Well done!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processSquats(landmarks) {
                const side = getVisibleSide(landmarks, [{l: 23, r: 24}, {l: 25, r: 26}, {l: 27, r: 28}]);
                if (!side) {
                    provideFeedback("Ensure your side is visible to the camera.");
                    return;
                }
                const hip = landmarks[side === 'left' ? 23 : 24];
                const knee = landmarks[side === 'left' ? 25 : 26];
                const ankle = landmarks[side === 'left' ? 27 : 28];
                const shoulder = landmarks[side === 'left' ? 11 : 12];
                const kneeAngle = calculateAngle(hip, knee, ankle);
                const hipAngle = calculateAngle(shoulder, hip, knee);
                if (kneeAngle === null || hipAngle === null) return;
                
                if (kneeAngle < 100) {
                    stage = "down";
                    lastCorrectForm = true;
                    if (hip.y > knee.y) { provideFeedback("Go deeper, hips below knees!"); formErrors[side + '_hip'] = true; formErrors[side + '_knee'] = true; lastCorrectForm = false; }
                    if (hipAngle < 80) { provideFeedback("Keep your chest up and back straight!"); formErrors[side + '_hip'] = true; lastCorrectForm = false; }
                }
                if (kneeAngle > 160 && stage === 'down') {
                    stage = "up";
                    if(lastCorrectForm){
                        repCounter++;
                        speak(String(repCounter));
                        repCountElement.textContent = repCounter;
                    } else {
                        provideFeedback("Rep not counted. Fix form.");
                    }
                }
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great squats!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processPushups(landmarks) {
                const side = getVisibleSide(landmarks, [{l: 11, r: 12}, {l: 13, r: 14}, {l: 15, r: 16}, {l:23, r:24}, {l:27, r:28}]);
                if (!side) {
                    provideFeedback("Position your full body sideways to the camera.");
                    return;
                }
                const shoulder = landmarks[side === 'left' ? 11 : 12];
                const elbow = landmarks[side === 'left' ? 13 : 14];
                const wrist = landmarks[side === 'left' ? 15 : 16];
                const hip = landmarks[side === 'left' ? 23 : 24];
                const ankle = landmarks[side === 'left' ? 27 : 28];
                const elbowAngle = calculateAngle(shoulder, elbow, wrist);
                const bodyAngle = calculateAngle(shoulder, hip, ankle);
                if(elbowAngle === null || bodyAngle === null) return;
                
                if (elbowAngle < 90) {
                    stage = "down";
                    lastCorrectForm = true;
                     if (bodyAngle < 165) { provideFeedback("Keep your back straight! Don't pike."); formErrors[side + '_hip'] = true; lastCorrectForm = false;}
                     if (shoulder.y > hip.y + 0.05) { provideFeedback("Don't drop your hips!"); formErrors[side + '_hip'] = true; lastCorrectForm = false; }
                }
                
                if (elbowAngle > 160 && stage === 'down') {
                    stage = "up";
                    if(lastCorrectForm) {
                        repCounter++;
                        speak(String(repCounter));
                        repCountElement.textContent = repCounter;
                    } else {
                        provideFeedback("Bad form, rep not counted.");
                    }
                }
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Awesome push-ups!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processHighKnees(landmarks) {
                const hipL = landmarks[23], hipR = landmarks[24];
                const kneeL = landmarks[25], kneeR = landmarks[26];
                
                if (hipL.visibility < 0.7 || hipR.visibility < 0.7 || kneeL.visibility < 0.7 || kneeR.visibility < 0.7) {
                    provideFeedback("Face the camera and ensure your legs are visible.");
                    return;
                }
                const leftKneeUp = kneeL.y < hipL.y;
                const rightKneeUp = kneeR.y < hipR.y;
                const fullReps = Math.floor(repCounter / 2);
                if (leftKneeUp && stage !== 'left_up') {
                    stage = 'left_up';
                    repCounter++;
                } else if (rightKneeUp && stage !== 'right_up') {
                    stage = 'right_up';
                    repCounter++;
                }
                
                if(repCountElement.textContent != fullReps && fullReps > 0){
                    repCountElement.textContent = fullReps;
                    speak(String(fullReps));
                }
                
                if (!leftKneeUp && !rightKneeUp) {
                    stage = 'down';
                }
                stageDisplay.textContent = stage || '-';
                if (fullReps >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Awesome pace!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processShoulderPress(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const elbowL = landmarks[13], elbowR = landmarks[14];
                const wristL = landmarks[15], wristR = landmarks[16];
                const hipL = landmarks[23], hipR = landmarks[24];
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || elbowL.visibility < 0.7 || elbowR.visibility < 0.7) {
                    provideFeedback("Please face the camera clearly.");
                    return;
                }
                const elbowAngleL = calculateAngle(shoulderL, elbowL, wristL);
                const elbowAngleR = calculateAngle(shoulderR, elbowR, wristR);
                const shoulderAngleL = calculateAngle(hipL, shoulderL, elbowL);
                const shoulderAngleR = calculateAngle(hipR, shoulderR, elbowR);
                
                if (elbowAngleL === null || elbowAngleR === null || shoulderAngleL === null || shoulderAngleR === null) return;
                const avgElbowAngle = (elbowAngleL + elbowAngleR) / 2;
                const avgShoulderAngle = (shoulderAngleL + shoulderAngleR) / 2;
                if (avgElbowAngle < 100 && avgShoulderAngle < 110) {
                    stage = "down";
                }
                
                if (avgElbowAngle > 155 && avgShoulderAngle > 145 && stage === 'down') {
                    stage = "up";
                    lastCorrectForm = true;
                    if (wristL.y > elbowL.y || wristR.y > elbowR.y) {
                        provideFeedback("Press higher!");
                        formErrors['left_shoulder'] = true;
                        formErrors['right_shoulder'] = true;
                        lastCorrectForm = false;
                    }
                    
                    if (lastCorrectForm) {
                        repCounter++;
                        speak(String(repCounter));
                        repCountElement.textContent = repCounter;
                    } else {
                        provideFeedback("Rep not counted, fix form.");
                    }
                }
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great press!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processLunges(landmarks) {
                const side = getVisibleSide(landmarks, [{l: 23, r: 24}, {l: 25, r: 26}, {l: 27, r: 28}]);
                if(!side) {
                    provideFeedback("Please stand sideways for lunge tracking.");
                    return;
                };
                const frontHip = landmarks[side === 'left' ? 23 : 24];
                const frontKnee = landmarks[side === 'left' ? 25 : 26];
                const frontAnkle = landmarks[side === 'left' ? 27 : 28];
                const backHip = landmarks[side === 'left' ? 24 : 23];
                const backKnee = landmarks[side === 'left' ? 26 : 25];
                const backAnkle = landmarks[side === 'left' ? 28 : 27];
                if(backKnee.visibility < 0.5) {
                    provideFeedback("Make sure your back leg is visible.");
                    return;
                }
                const frontKneeAngle = calculateAngle(frontHip, frontKnee, frontAnkle);
                const backKneeAngle = calculateAngle(backHip, backKnee, backAnkle);
                if(frontKneeAngle === null || backKneeAngle === null) return;
                
                if(frontKneeAngle < 100 && backKneeAngle < 120) {
                    stage = "down";
                    lastCorrectForm = true;
                    if(Math.abs(frontKnee.x - frontAnkle.x) > 0.15) { 
                        provideFeedback("Keep front knee from going past your toes!"); 
                        formErrors[side + '_knee'] = true;
                        lastCorrectForm = false; 
                    }
                }
                if(frontKneeAngle > 160 && backKneeAngle > 160 && stage === 'down') {
                    stage = "up";
                    if(lastCorrectForm){
                        repCounter++;
                        speak(String(repCounter));
                        repCountElement.textContent = repCounter;
                    } else {
                        provideFeedback("Bad form on that lunge.");
                    }
                }
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Fantastic lunges!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processLateralRaises(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const elbowL = landmarks[13], elbowR = landmarks[14];
                const hipL = landmarks[23], hipR = landmarks[24];
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7) {
                    provideFeedback("Face the camera for lateral raises.");
                    return;
                }
                const leftAngle = calculateAngle(hipL, shoulderL, elbowL);
                const rightAngle = calculateAngle(hipR, shoulderR, elbowR);
                if (leftAngle === null || rightAngle === null) return;
                
                const avgAngle = (leftAngle + rightAngle) / 2;
                if (avgAngle < 30) {
                    stage = "down";
                }
                if (avgAngle > 80 && stage === 'down') {
                    stage = "up";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Awesome raises!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processOverheadTricepExtensions(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const elbowL = landmarks[13], elbowR = landmarks[14];
                const wristL = landmarks[15], wristR = landmarks[16];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    elbowL.visibility < 0.7 || elbowR.visibility < 0.7) {
                    provideFeedback("Face the camera clearly for tricep extensions.");
                    return;
                }
                
                const leftElbowAngle = calculateAngle(shoulderL, elbowL, wristL);
                const rightElbowAngle = calculateAngle(shoulderR, elbowR, wristR);
                
                if (leftElbowAngle === null || rightElbowAngle === null) return;
                
                const avgElbowAngle = (leftElbowAngle + rightElbowAngle) / 2;
                
                if (avgElbowAngle > 160) {
                    stage = "down";
                }
                
                if (avgElbowAngle < 90 && stage === 'down') {
                    stage = "up";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great tricep extensions!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processJumpingJacks(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const elbowL = landmarks[13], elbowR = landmarks[14];
                const hipL = landmarks[23], hipR = landmarks[24];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7) {
                    provideFeedback("Face the camera and ensure full body is visible.");
                    return;
                }
                
                const armAngleL = calculateAngle(hipL, shoulderL, elbowL);
                const armAngleR = calculateAngle(hipR, shoulderR, elbowR);
                const legDistance = Math.abs(ankleL.x - ankleR.x);
                
                if (armAngleL === null || armAngleR === null) return;
                
                const avgArmAngle = (armAngleL + armAngleR) / 2;
                
                // Detect jumping jack positions
                const isArmsUp = avgArmAngle > 120;
                const isLegsOut = legDistance > 0.3;
                
                if (isArmsUp && isLegsOut && stage !== 'up') {
                    stage = 'up';
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                } else if (!isArmsUp && !isLegsOut) {
                    stage = 'down';
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great jumping jacks!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processGluteBridges(landmarks) {
                const hipL = landmarks[23], hipR = landmarks[24];
                const kneeL = landmarks[25], kneeR = landmarks[26];
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                
                if (hipL.visibility < 0.7 || hipR.visibility < 0.7 || 
                    kneeL.visibility < 0.7 || kneeR.visibility < 0.7 ||
                    shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7) {
                    provideFeedback("Lie on your back with side visible to camera.");
                    return;
                }
                
                const avgHipY = (hipL.y + hipR.y) / 2;
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                const hipLift = avgShoulderY - avgHipY;
                
                if (hipLift < 0.05) {
                    stage = "down";
                }
                
                if (hipLift > 0.15 && stage === 'down') {
                    stage = "up";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great glute bridges!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processCrunches(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7) {
                    provideFeedback("Lie on your back with side visible to camera.");
                    return;
                }
                
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                const avgHipY = (hipL.y + hipR.y) / 2;
                const crunchAngle = Math.abs(avgShoulderY - avgHipY);
                
                if (crunchAngle < 0.05) {
                    stage = "down";
                }
                
                if (crunchAngle > 0.15 && stage === 'down') {
                    stage = "up";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great crunches!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processSitups(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7) {
                    provideFeedback("Lie on your back with side visible to camera.");
                    return;
                }
                
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                const avgHipY = (hipL.y + hipR.y) / 2;
                const situpAngle = Math.abs(avgShoulderY - avgHipY);
                
                if (situpAngle < 0.05) {
                    stage = "down";
                }
                
                if (situpAngle > 0.25 && stage === 'down') {
                    stage = "up";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great situps!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processRussianTwists(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7) {
                    provideFeedback("Sit with upper body visible to camera.");
                    return;
                }
                
                const shoulderDistance = Math.abs(shoulderL.x - shoulderR.x);
                const hipDistance = Math.abs(hipL.x - hipR.x);
                const twistRatio = shoulderDistance / hipDistance;
                
                if (twistRatio < 1.2) {
                    stage = "center";
                }
                
                if (twistRatio > 1.8 && stage === 'center') {
                    stage = 'twisted';
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great russian twists!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processLegRaises(landmarks) {
                const hipL = landmarks[23], hipR = landmarks[24];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                
                if (hipL.visibility < 0.7 || hipR.visibility < 0.7 || 
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7) {
                    provideFeedback("Lie on your back with legs visible to camera.");
                    return;
                }
                
                const avgHipY = (hipL.y + hipR.y) / 2;
                const avgAnkleY = (ankleL.y + ankleR.y) / 2;
                const legRaiseHeight = Math.abs(avgHipY - avgAnkleY);
                
                if (legRaiseHeight < 0.05) {
                    stage = "down";
                }
                
                if (legRaiseHeight > 0.2 && stage === 'down') {
                    stage = "up";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great leg raises!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processTricepDips(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const elbowL = landmarks[13], elbowR = landmarks[14];
                const hipL = landmarks[23], hipR = landmarks[24];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    elbowL.visibility < 0.7 || elbowR.visibility < 0.7 ||
                    hipL.visibility < 0.7 || hipR.visibility < 0.7) {
                    provideFeedback("Position yourself with arms and upper body visible.");
                    return;
                }
                
                const leftElbowAngle = calculateAngle(shoulderL, elbowL, hipL);
                const rightElbowAngle = calculateAngle(shoulderR, elbowR, hipR);
                
                if (leftElbowAngle === null || rightElbowAngle === null) return;
                
                const avgElbowAngle = (leftElbowAngle + rightElbowAngle) / 2;
                
                if (avgElbowAngle > 160) {
                    stage = "up";
                }
                
                if (avgElbowAngle < 90 && stage === 'up') {
                    stage = "down";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great tricep dips!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processBurpees(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7 ||
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                const avgHipY = (hipL.y + hipR.y) / 2;
                const avgAnkleY = (ankleL.y + ankleR.y) / 2;
                
                const bodyAlignment = Math.abs(avgShoulderY - avgHipY) + Math.abs(avgHipY - avgAnkleY);
                
                if (bodyAlignment < 0.1) {
                    stage = "plank";
                }
                
                if (bodyAlignment > 0.4 && stage === "plank") {
                    stage = "jump";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great burpees!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processMountainClimbers(landmarks) {
                const kneeL = landmarks[25], kneeR = landmarks[26];
                const hipL = landmarks[23], hipR = landmarks[24];
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                
                if (kneeL.visibility < 0.7 || kneeR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7 ||
                    shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                const leftKneeUp = kneeL.y < hipL.y;
                const rightKneeUp = kneeR.y < hipR.y;
                const fullReps = Math.floor(repCounter / 2);
                
                if (leftKneeUp && stage !== 'left_up') {
                    stage = 'left_up';
                    repCounter++;
                } else if (rightKneeUp && stage !== 'right_up') {
                    stage = 'right_up';
                    repCounter++;
                }
                
                if (!leftKneeUp && !rightKneeUp) {
                    stage = 'plank';
                }
                
                if(repCountElement.textContent != fullReps && fullReps > 0){
                    repCountElement.textContent = fullReps;
                    speak(String(fullReps));
                }
                
                stageDisplay.textContent = stage || '-';
                if (fullReps >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great mountain climbers!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processSkaterJumps(landmarks) {
                const ankleL = landmarks[27], ankleR = landmarks[28];
                const hipL = landmarks[23], hipR = landmarks[24];
                
                if (ankleL.visibility < 0.7 || ankleR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7) {
                    provideFeedback("Ensure lower body is visible to camera.");
                    return;
                }
                
                const legDistance = Math.abs(ankleL.x - ankleR.x);
                const hipDistance = Math.abs(hipL.x - hipR.x);
                const jumpRatio = legDistance / hipDistance;
                
                if (jumpRatio < 1.5) {
                    stage = "center";
                }
                
                if (jumpRatio > 2.5 && stage === 'center') {
                    stage = 'jumped';
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great skater jumps!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processButtKicks(landmarks) {
                const ankleL = landmarks[27], ankleR = landmarks[28];
                const hipL = landmarks[23], hipR = landmarks[24];
                
                if (ankleL.visibility < 0.7 || ankleR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7) {
                    provideFeedback("Ensure lower body is visible to camera.");
                    return;
                }
                
                const leftHeelUp = ankleL.y < hipL.y;
                const rightHeelUp = ankleR.y < hipR.y;
                const fullReps = Math.floor(repCounter / 2);
                
                if (leftHeelUp && stage !== 'left_up') {
                    stage = 'left_up';
                    repCounter++;
                } else if (rightHeelUp && stage !== 'right_up') {
                    stage = 'right_up';
                    repCounter++;
                }
                
                if (!leftHeelUp && !rightHeelUp) {
                    stage = 'down';
                }
                
                if(repCountElement.textContent != fullReps && fullReps > 0){
                    repCountElement.textContent = fullReps;
                    speak(String(fullReps));
                }
                
                stageDisplay.textContent = stage || '-';
                if (fullReps >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great butt kicks!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processJumpSquats(landmarks) {
                const hipL = landmarks[23], hipR = landmarks[24];
                const kneeL = landmarks[25], kneeR = landmarks[26];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                
                if (hipL.visibility < 0.7 || hipR.visibility < 0.7 || 
                    kneeL.visibility < 0.7 || kneeR.visibility < 0.7 ||
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7 ||
                    shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                const avgKneeY = (kneeL.y + kneeR.y) / 2;
                const avgAnkleY = (ankleL.y + ankleR.y) / 2;
                const avgHipY = (hipL.y + hipR.y) / 2;
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                
                const squatDepth = Math.abs(avgHipY - avgKneeY);
                const jumpHeight = Math.abs(avgShoulderY - avgHipY);
                
                if (squatDepth > 0.15 && jumpHeight < 0.1) {
                    stage = "squat";
                }
                
                if (jumpHeight > 0.25 && stage === 'squat') {
                    stage = "jump";
                    repCounter++;
                    speak(String(repCounter));
                    repCountElement.textContent = repCounter;
                }
                
                stageDisplay.textContent = stage || '-';
                if (repCounter >= parseInt(repTargetInput.value)) {
                    provideFeedback("Set complete! Great jump squats!");
                    stopWorkoutBtn.click();
                }
            }
            
            function processPlank(landmarks, isSide) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7 ||
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                const avgHipY = (hipL.y + hipR.y) / 2;
                const avgAnkleY = (ankleL.y + ankleR.y) / 2;
                
                const bodyAlignment = Math.abs(avgShoulderY - avgHipY) + Math.abs(avgHipY - avgAnkleY);
                
                // Check if in plank position
                if (bodyAlignment < 0.1) {
                    if (!stage) {
                        stage = "plank";
                        timerInterval = setInterval(() => {
                            secondsElapsed++;
                            repCountElement.textContent = secondsElapsed + "s";
                            
                            if (secondsElapsed >= parseInt(repTargetInput.value)) {
                                provideFeedback("Set complete! Great plank!");
                                stopWorkoutBtn.click();
                            }
                        }, 1000);
                    }
                } else {
                    if (stage === "plank") {
                        provideFeedback("Maintain proper plank position!");
                        if (timerInterval) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                        }
                        stage = null;
                    }
                }
                
                stageDisplay.textContent = stage || '-';
            }
            
            function processTreePose(landmarks) {
                const hipL = landmarks[23], hipR = landmarks[24];
                const kneeL = landmarks[25], kneeR = landmarks[26];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                
                if (hipL.visibility < 0.7 || hipR.visibility < 0.7 || 
                    kneeL.visibility < 0.7 || kneeR.visibility < 0.7 ||
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7 ||
                    shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                // Check if one foot is raised
                const leftFootUp = kneeL.y < hipL.y && ankleL.y < kneeL.y;
                const rightFootUp = kneeR.y < hipR.y && ankleR.y < kneeR.y;
                
                if ((leftFootUp || rightFootUp) && !stage) {
                    stage = "tree";
                    timerInterval = setInterval(() => {
                        secondsElapsed++;
                        repCountElement.textContent = secondsElapsed + "s";
                        
                        if (secondsElapsed >= parseInt(repTargetInput.value)) {
                            provideFeedback("Set complete! Great tree pose!");
                            stopWorkoutBtn.click();
                        }
                    }, 1000);
                } else if (!leftFootUp && !rightFootUp && stage === "tree") {
                    provideFeedback("Keep your foot raised!");
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    stage = null;
                }
                
                stageDisplay.textContent = stage || '-';
            }
            
            function processWarriorPose(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                const kneeL = landmarks[25], kneeR = landmarks[26];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7 ||
                    kneeL.visibility < 0.7 || kneeR.visibility < 0.7 ||
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                // Check if in warrior pose (one leg bent, one leg straight, arms extended)
                const leftKneeBent = Math.abs(kneeL.x - hipL.x) > 0.1 && Math.abs(kneeL.x - ankleL.x) < 0.05;
                const rightKneeBent = Math.abs(kneeR.x - hipR.x) > 0.1 && Math.abs(kneeR.x - ankleR.x) < 0.05;
                const armsExtended = Math.abs(shoulderL.y - landmarks[15].y) > 0.2 && 
                                     Math.abs(shoulderR.y - landmarks[16].y) > 0.2;
                
                if ((leftKneeBent || rightKneeBent) && armsExtended && !stage) {
                    stage = "warrior";
                    timerInterval = setInterval(() => {
                        secondsElapsed++;
                        repCountElement.textContent = secondsElapsed + "s";
                        
                        if (secondsElapsed >= parseInt(repTargetInput.value)) {
                            provideFeedback("Set complete! Great warrior pose!");
                            stopWorkoutBtn.click();
                        }
                    }, 1000);
                } else if ((!leftKneeBent && !rightKneeBent || !armsExtended) && stage === "warrior") {
                    provideFeedback("Maintain proper warrior pose!");
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    stage = null;
                }
                
                stageDisplay.textContent = stage || '-';
            }
            
            function processDownwardDog(landmarks) {
                const shoulderL = landmarks[11], shoulderR = landmarks[12];
                const hipL = landmarks[23], hipR = landmarks[24];
                const ankleL = landmarks[27], ankleR = landmarks[28];
                
                if (shoulderL.visibility < 0.7 || shoulderR.visibility < 0.7 || 
                    hipL.visibility < 0.7 || hipR.visibility < 0.7 ||
                    ankleL.visibility < 0.7 || ankleR.visibility < 0.7) {
                    provideFeedback("Ensure full body is visible to camera.");
                    return;
                }
                
                const avgShoulderY = (shoulderL.y + shoulderR.y) / 2;
                const avgHipY = (hipL.y + hipR.y) / 2;
                const avgAnkleY = (ankleL.y + ankleR.y) / 2;
                
                // Check if in downward dog position (hips up, forming inverted V)
                const hipHeight = Math.abs(avgShoulderY - avgHipY);
                const legAlignment = Math.abs(avgHipY - avgAnkleY);
                
                if (hipHeight > 0.15 && legAlignment < 0.1 && !stage) {
                    stage = "downward_dog";
                    timerInterval = setInterval(() => {
                        secondsElapsed++;
                        repCountElement.textContent = secondsElapsed + "s";
                        
                        if (secondsElapsed >= parseInt(repTargetInput.value)) {
                            provideFeedback("Set complete! Great downward dog!");
                            stopWorkoutBtn.click();
                        }
                    }, 1000);
                } else if ((hipHeight < 0.1 || legAlignment > 0.15) && stage === "downward_dog") {
                    provideFeedback("Maintain proper downward dog position!");
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    stage = null;
                }
                
                stageDisplay.textContent = stage || '-';
            }
            const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
            pose.setOptions({
                modelComplexity: 1, smoothLandmarks: true, enableSegmentation: false,
                smoothSegmentation: true, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6
            });
            pose.onResults(onResults);
            let cameraInstance = null;
            
            exerciseSelect.addEventListener('change', setupExerciseUI);
            repTargetInput.addEventListener('change', setupExerciseUI);
            
            startWorkoutBtn.addEventListener('click', () => {
                workoutDisplayArea.style.display = 'flex';
                workoutStats.classList.remove('hidden');
                startWorkoutBtn.classList.add('hidden');
                stopWorkoutBtn.classList.remove('hidden');
                
                // Load and play the workout video
                const selectedExercise = exerciseSelect.value;
                if (exerciseVideos[selectedExercise]) {
                    workoutVideo.src = exerciseVideos[selectedExercise];
                    workoutVideo.play();
                }
                
                if (!cameraInstance) {
                    cameraInstance = new Camera(videoElement, {
                        onFrame: async () => { await pose.send({ image: videoElement }); },
                        width: 640, height: 360
                    });
                    cameraInstance.start();
                }
                
                isWorkoutActive = true;
                repCounter = 0;
                secondsElapsed = 0;
                stage = null;
                lastCorrectForm = true;
                setupExerciseUI(); 
                feedbackTextElement.textContent = `Starting ${exerciseSelect.options[exerciseSelect.selectedIndex].text}...`;
                speak(`Starting ${exerciseSelect.options[exerciseSelect.selectedIndex].text}. Target is ${repTargetInput.value}.`);
            });
            
            stopWorkoutBtn.addEventListener('click', () => {
                isWorkoutActive = false;
                startWorkoutBtn.classList.remove('hidden');
                stopWorkoutBtn.classList.add('hidden');
                workoutDisplayArea.style.display = 'none';
                
                // Pause the workout video
                workoutVideo.pause();
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                if (cameraInstance) {
                    cameraInstance.stop();
                    cameraInstance = null;
                    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                }
                
                feedbackTextElement.textContent = "Workout stopped.";
                if(repCounter > 0 || secondsElapsed > 0) speak("Workout stopped. Great job!");
            });
            
            // Mouse tracking for hover effects
            document.addEventListener('mousemove', (e) => {
                const cursor = document.querySelector('.custom-cursor');
                cursor.style.left = `${e.clientX}px`;
                cursor.style.top = `${e.clientY}px`;
                const cards = document.querySelectorAll('.feature-card, .chat-container');
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                        card.style.setProperty('--mouse-x', `${(x / rect.width) * 100}%`);
                        card.style.setProperty('--mouse-y', `${(y / rect.height) * 100}%`);
                    }
                });
            });
            
            // Enhanced click effect with smash effect and sound
            let breakSound = null;
            try { breakSound = new Audio("click.mp3.wav"); } catch (e) { console.error("Error loading sound:", e); }
            document.addEventListener('click', (e) => {
                if (breakSound) {
                    breakSound.volume = 0.5; breakSound.currentTime = 0;
                    breakSound.play().catch(err => console.error("Audio play failed:", err));
                }
                const screenCrack = document.querySelector('.screen-crack');
                screenCrack.style.setProperty('--crack-x', `${e.clientX}px`);
                screenCrack.style.setProperty('--crack-y', `${e.clientY}px`);
                screenCrack.classList.add('active');
                setTimeout(() => { screenCrack.classList.remove('active'); }, 400);
                const smashContainer = document.querySelector('.smash-container');
                const sportIcons = [
                    'fas fa-dumbbell', 'fas fa-running', 'fas fa-bicycle', 'fas fa-swimmer',
                    'fas fa-fist-raised', 'fas fa-basketball-ball', 'fas fa-football-ball',
                    'fas fa-table-tennis', 'fas fa-volleyball-ball', 'fas fa-baseball-ball'
                ];
                const newGlassBreak = { x: e.clientX - 75, y: e.clientY - 75 };
                const glassBreak = document.createElement('div');
                glassBreak.className = 'glass-break';
                glassBreak.style.left = `${newGlassBreak.x}px`;
                glassBreak.style.top = `${newGlassBreak.y}px`;
                glassBreak.style.width = '150px'; glassBreak.style.height = '150px'; glassBreak.style.borderRadius = '50%';
                glassBreak.style.background = 'radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(0,255,255,0.5) 50%, transparent 70%)';
                smashContainer.appendChild(glassBreak);
                for (let i = 0; i < 25; i++) {
                    const shard = document.createElement('div'); shard.className = 'glass-shard';
                    shard.style.left = `${e.clientX}px`; shard.style.top = `${e.clientY}px`;
                    shard.style.width = `${Math.random() * 15 + 5}px`; shard.style.height = `${Math.random() * 20 + 8}px`;
                    shard.style.setProperty('--tx', `${(Math.random() - 0.5) * 150}px`); shard.style.setProperty('--ty', `${(Math.random() - 0.5) * 150}px`);
                    shard.style.setProperty('--rotation', `${(Math.random() - 0.5) * 360}deg`);
                    shard.style.animationDuration = `${Math.random() * 0.8 + 0.8}s`;
                    smashContainer.appendChild(shard);
                }
                for (let i = 0; i < 25; i++) {
                    const particle = document.createElement('div'); particle.className = 'smash-particle';
                    particle.style.left = `${e.clientX}px`; particle.style.top = `${e.clientY}px`;
                    particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 150}px`);
                    particle.style.setProperty('--ty', `${(Math.random() - 0.5) * 150}px`);
                    particle.style.animationDuration = `${Math.random() * 0.8 + 0.8}s`;
                    particle.innerHTML = `<i class="${sportIcons[Math.floor(Math.random() * sportIcons.length)]}"></i>`;
                    smashContainer.appendChild(particle);
                }
                setTimeout(() => {
                    glassBreak.remove();
                    smashContainer.querySelectorAll('.glass-shard').forEach(s => s.remove());
                    smashContainer.querySelectorAll('.smash-particle').forEach(p => p.remove());
                }, 1500);
            });
            
            const sections = document.querySelectorAll('section');
            const observerOptions = { root: null, rootMargin: '0px', threshold: 0.5 };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        const sectionTitle = entry.target.querySelector('.section-title');
                        if (sectionTitle) { sectionTitle.classList.add('visible'); }
                        const cards = entry.target.querySelectorAll('.feature-card');
                        cards.forEach((card, index) => {
                            setTimeout(() => { card.classList.add('animate-in'); }, 150 * index);
                        });
                    }
                });
            }, observerOptions);
            sections.forEach(section => {
                section.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(section);
            });
            document.getElementById('chat-coach').classList.add('visible');
            const firstSectionTitle = document.querySelector('#chat-coach .section-title');
            if (firstSectionTitle) { firstSectionTitle.classList.add('visible'); }
            const firstSectionCards = document.querySelectorAll('#chat-coach .feature-card');
            firstSectionCards.forEach((card, index) => {
                setTimeout(() => { card.classList.add('animate-in'); }, 100 * index);
            });
            
            // Initialize UI for the default selected exercise
            setupExerciseUI();
        });
    </script>
</body>
</html>